(()=>{var L=Object.defineProperty,_=(t,e,i)=>e in t?L(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,$=(t,e,i)=>(_(t,e+"",i),i),M=/^([^:]+):(@?\S+)$/,H=class S{constructor(e,i,s){this.title=e,this.type=i,this.value=s}static parse(e){let i=M.exec(e);if(!i)return null;let s=i[1].replaceAll("_"," "),n=i[2][0]=="@"?"event":"command",r=i[2][0]=="@"?i[2].slice(1):i[2];return new S(s,n,r)}},x=document.createElement("template");x.innerHTML=`
<button hidden>Run</button>
<a href="#edit" hidden>Edit</a>
<codapi-status></codapi-status>
`;var N=class extends HTMLElement{constructor(){super()}connectedCallback(){this.ready||(this.render(),this.listen(),this.ready=!0)}render(){this.appendChild(x.content.cloneNode(!0)),this.run=this.querySelector("button"),this.edit=this.querySelector("a"),this.status=this.querySelector("codapi-status");let t=this.getAttribute("actions");this.addActions(t?t.split(" "):null)}listen(){this.run.addEventListener("click",t=>{this.dispatchEvent(new Event("run"))}),this.edit.addEventListener("click",t=>{t.preventDefault(),this.dispatchEvent(new Event("edit"))})}addActions(t){if(t)for(let e of t){let i=H.parse(e);if(!i)continue;let s=this.createButton(i);this.insertBefore(s,this.status)}}createButton(t){let e=document.createElement("a");return e.addEventListener("click",i=>{i.preventDefault();let s=new CustomEvent(t.type,{detail:t.value});this.dispatchEvent(s)}),e.innerText=t.title,e.href="#"+t.value,e}showRunning(){this.run.setAttribute("disabled",""),this.status.showRunning()}showFinished(t){this.run.removeAttribute("disabled"),this.status.showFinished(t)}showStatus(t){this.run.removeAttribute("disabled"),this.status.showMessage(t)}get runnable(){return!this.run.hasAttribute("hidden")}set runnable(t){t?this.run.removeAttribute("hidden"):this.run.setAttribute("hidden","")}get editable(){return!this.edit.hasAttribute("hidden")}set editable(t){t?this.edit.removeAttribute("hidden"):this.edit.setAttribute("hidden","")}};window.customElements.get("codapi-toolbar")||customElements.define("codapi-toolbar",N);var w={running:"Running...",failed:"✘ Failed",done:"✓ Done"},F=class extends HTMLElement{showRunning(){let t=this.getAttribute("running")||w.running;this.innerHTML=`
            <svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"><animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12" repeatCount="indefinite"/></path></svg>
            ${t}
        `}showFinished(t){if(!t.ok){this.innerText=this.getAttribute("failed")||w.failed;return}let e=this.getAttribute("done")||w.done;e=e.replace("$DURATION",t.duration),this.innerHTML=`
            ${e}
            <codapi-ref>by <a href="https://codapi.org/">codapi</a></codapi-ref>`}showMessage(t){this.innerText=t}};window.customElements.get("codapi-status")||customElements.define("codapi-status",F);function O(t){if(!t.length)return document.createTextNode("");let e=document.createElement("table"),i=document.createElement("thead"),s=document.createElement("tbody"),n=document.createElement("tr");return Object.keys(t[0]).forEach(r=>{let o=document.createElement("th");o.textContent=r,n.appendChild(o)}),i.appendChild(n),t.forEach(r=>{let o=document.createElement("tr");Object.values(r).forEach(d=>{let g=document.createElement("td");g.textContent=d,o.appendChild(g)}),s.appendChild(o)}),e.appendChild(i),e.appendChild(s),e}var q={asTable:O},m="---";function D(t,e){let i=t.indexOf(e);return i>=0?[t.slice(0,i),t.slice(i+e.length)]:[t,""]}function j(t){if(t.endsWith(m))return"";let e=t.lastIndexOf(`
${m}
`);return e!==-1?t.slice(e+m.length+2):t.startsWith(m)?t.slice(m.length+1):t}var c={cut:D,tail:j,HORIZONTAL_RULE:m},u={text:"text",table:"table",svg:"svg",html:"html",iframe:"iframe",dom:"dom",hidden:"hidden"},R="ok",E=document.createElement("template");E.innerHTML=`
<a href="#close">✕</a>
<pre><code></code></pre>
`;var I={[u.text]:(t,e)=>{let i=t.stdout||t.stderr,s=e?c.tail(i):i;return document.createTextNode(s||R)},[u.table]:t=>{if(!t.stdout)return document.createTextNode(t.stderr);let e=typeof t.stdout=="object"?t.stdout:JSON.parse(t.stdout);return q.asTable(e)},[u.svg]:t=>{if(!t.stdout)return document.createTextNode(t.stderr);let e=new DOMParser().parseFromString(t.stdout,"image/svg+xml");return e.querySelector("parsererror")?document.createTextNode(t.stdout):e.documentElement},[u.html]:t=>{if(!t.stdout)return document.createTextNode(t.stderr);let e=new DOMParser().parseFromString(t.stdout,"text/html");if(e.querySelector("parsererror"))return document.createTextNode(t.stdout);let i=document.createDocumentFragment();return Array.from(e.body.childNodes).forEach(s=>i.appendChild(s)),i},[u.iframe]:t=>{if(!t.stdout)return document.createTextNode(t.stderr);let e=new DOMParser().parseFromString(t.stdout,"text/html");if(e.querySelector("parsererror"))return document.createTextNode(t.stdout);let i=document.createElement("iframe");return i.width="100%",i.srcdoc=e.documentElement.outerHTML,i.onload=()=>{let s=i.contentDocument.body,n=i.contentDocument.documentElement,r=Math.max(s.scrollHeight,s.offsetHeight,n.clientHeight,n.scrollHeight,n.offsetHeight);i.style.height=r+"px"},i},[u.dom]:t=>t.stdout?t.stdout:document.createTextNode(t.stderr),[u.hidden]:t=>!t.stdout&&t.stderr?document.createTextNode(t.stderr):null},P=class extends HTMLElement{constructor(){super()}connectedCallback(){this.ready||(this.appendChild(E.content.cloneNode(!0)),this.close=this.querySelector("a"),this.output=this.querySelector("pre > code"),this.close.addEventListener("click",t=>{t.preventDefault(),this.hide()}),this.ready=!0)}fadeOut(){this.style.opacity=.4}fadeIn(){setTimeout(()=>{this.style.opacity=""},100)}showResult(t){let e=I[this.mode](t,this.tail);if(this.output.innerHTML="",!e){this.hide();return}this.output.appendChild(e),this.show()}showMessage(t){this.output.innerText=t,t?this.show():this.hide()}showError(t){let e=t.message+(t.stack?`
${t.stack}`:"");this.showMessage(e)}show(){this.removeAttribute("hidden")}hide(){this.setAttribute("hidden","")}get mode(){return this.getAttribute("mode")||u.text}set mode(t){t in u||(t=u.text),this.setAttribute("mode",t)}get tail(){return this.hasAttribute("tail")}set tail(t){t?this.setAttribute("tail",""):this.removeAttribute("tail")}};window.customElements.get("codapi-output")||customElements.define("codapi-output",P);var b={off:"off",basic:"basic",external:"external"},B=class extends EventTarget{constructor(t,e,i){super(),this.el=t,this.mode=e,this.executeFunc=i,this.fixFormatting(),this.listen()}listen(){if(this.mode!=b.off){if(this.mode==b.external){this.el.addEventListener("keydown",this.handleExecute.bind(this));return}this.el.contentEditable="true",this.el.addEventListener("keydown",this.handleIndent.bind(this)),this.el.addEventListener("keydown",this.handleHide.bind(this)),this.el.addEventListener("keydown",this.handleExecute.bind(this)),this.el.addEventListener("paste",this.onPaste.bind(this)),this.onFocus=this.initEditor.bind(this),this.el.addEventListener("focus",this.onFocus)}}initEditor(t){let e=t.target;e.innerHTML.includes("</span>")&&(e.textContent=e.textContent),e.removeEventListener("focus",this.onFocus),delete this.onFocus}handleIndent(t){t.key=="Tab"&&(t.preventDefault(),document.execCommand("insertHTML",!1," ".repeat(4)))}handleHide(t){t.key=="Escape"&&(t.preventDefault(),this.dispatchEvent(new Event("hide")))}handleExecute(t){!t.ctrlKey&&!t.metaKey||t.key!=="Enter"&&t.key!=="NumpadEnter"||(t.preventDefault(),this.executeFunc())}onPaste(t){t.preventDefault();let e=(t.originalEvent||t).clipboardData.getData("text/plain");document.execCommand("insertText",!1,e)}fixFormatting(){setTimeout(()=>{this.el.innerHTML=this.el.innerHTML.replaceAll("<br>",`
`).replace(/[\u00A0]/g," ")},0)}focusEnd(){this.el.focus();let t=window.getSelection();t.selectAllChildren(this.el),t.collapseToEnd()}get isEmpty(){return this.el.textContent.trim()==""}get value(){return this.el.textContent.trim()}set value(t){this.el.textContent=t}},a=window.codapi??{};a.version="0.19.7",a.engines=a.engines??{},a.settings=a.settings??{},window.codapi=a;var W=class extends HTMLElement{connectedCallback(){this.ready||(a.settings.url=this.getAttribute("url"),this.ready=!0)}attributeChangedCallback(t,e,i){a.settings[t]=i}};window.customElements.get("codapi-settings")||customElements.define("codapi-settings",W);async function v(t,e={}){let{timeout:i=1e4}=e,s=new AbortController,n=setTimeout(()=>s.abort(),i),r=await fetch(t,{...e,signal:s.signal});return clearTimeout(n),r}var U="https://api.codapi.org/v1",J="Something is wrong with Codapi.",Z={400:"Bad request. Something is wrong with the request, not sure what.",404:"Unknown sandbox or command.",403:"Forbidden. Your domain is probably not allowed on Codapi.",413:"Request is too large. Try submitting less code.",429:"Too many requests. Try again in a few seconds."};async function K(t){try{let e=`${a.settings.url||U}/exec`,i=await v(e,{method:"POST",headers:{accept:"application/json","content-type":"application/json"},body:JSON.stringify(t)});if(!i.ok){let s=Z[i.status]||J;return{ok:!1,duration:0,stdout:"",stderr:`${i.status} - ${s}`}}return await i.json()}catch(e){throw new Error("request failed",{cause:e})}}var G={init:()=>{},exec:K};async function Y(t){try{let e=z(t.files[""]),[i,s]=await Q(e);return{ok:!0,duration:s,stdout:i,stderr:""}}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}}function z(t){let e=t.split(`
`),i=0,s=e[0].split(" ").filter(h=>h),[n,r]=s.length>=2?s:["GET",s[0]];i+=1;let o=[];for(let h=i;h<e.length;h++){let p=e[h].trim();if(p.startsWith("?")||p.startsWith("&"))o.push(p),i+=1;else break}let d={};for(let h=i;h<e.length;h++){let p=e[h].trim();if(p==="")break;let[At,Tt]=c.cut(p,":");d[At.trim()]=Tt.trim(),i+=1}let g=e.slice(i+1).join(`
`);return{method:n,url:r+o.join(""),headers:d,body:g}}async function Q(t){let e=new Date,i=await V(t),s=await X(i),n=new Date-e;return[s,n]}async function V(t){let e={method:t.method,headers:t.headers,body:t.body||void 0};return await v(t.url,e)}async function X(t){let e="HTTP/1.1",i=await t.text(),s=[`${e} ${t.status} ${t.statusText}`];for(let n of t.headers.entries())s.push(`${n[0]}: ${n[1]}`);return i&&s.push("",i),s.join(`
`)}var tt={exec:Y},et=(async function(){}).constructor;async function it(t){try{let e=[];nt(e);let[i,s]=await st(t.files[""]);return{ok:!0,duration:s,stdout:i??e.join(`
`),stderr:""}}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}finally{rt()}}async function st(t){let e=new et(t),i=new Date,s=await e(),n=new Date-i;return[s,n]}function nt(t){let e=new Proxy(console,{get(i,s){return s==="log"||s==="error"||s==="warn"||s==="info"||s==="debug"?(...n)=>{let r=n.map(o=>ot(o)).join(" ");t.push(r),i[s](...n)}:i[s]}});window._console=window.console,window.console=e,window.addEventListener("error",i=>console.log(i.error))}function rt(){window.console=window._console,delete window._console}function ot(t){switch(typeof t){case"undefined":return"undefined";case"object":return JSON.stringify(t);default:return t.toString()}}var at={exec:it},y={javascript:at.exec,fetch:tt.exec};async function ut(t){try{return lt(t)(t)}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}}function lt(t){if(!(t.sandbox in y))throw Error(`unknown sandbox: ${t.sandbox}`);if(t.command!="run")throw Error(`unknown command: ${t.sandbox}.${t.command}`);return y[t.sandbox]}var dt={init:()=>{},exec:ut},ht="codapi",ct="run",A=class{constructor({engine:t,sandbox:e,command:i,template:s,files:n}){let[r,o]=c.cut(e||"",":");this.engineName=t||ht,this.sandbox=r,this.version=o,this.command=i||ct,this.template=s,this.files=n}get engine(){let t=a.engines[this.engineName];if(!t)throw new Error(`unknown engine: ${this.engineName}`);return t}async execute(t,e){e=await this.prepare(e);let i=await this.loadFiles();return await this.engine.exec({sandbox:this.sandbox,version:this.version,command:t||this.command,files:{"":e,...i}})}async prepare(t){if(!this.template)return t;let e="##CODE##",[i,s]=await T(this.template,mt);return t=s.replace(e,()=>t),t}async loadFiles(){if(!this.files)return{};let t={};for(let e of this.files){let[i,s]=c.cut(e,":"),[n,r]=await T(i,pt);t[s||n]=r}return t}};async function T(t,e){if(t[0]=="#"){let r=t.slice(1),o=document.getElementById(r);if(!o)throw new Error(`element ${t} not found`);let d=o.code||o.textContent.trim();return[r,d]}let i=t.split("/").pop(),s=await fetch(t);if(s.status!=200)throw new Error(`file ${t} not found`);let n=await e(s);return[i,n]}async function mt(t){return await t.text()}async function pt(t){if(t.headers.get("content-type")=="application/octet-stream"){let e=await t.blob();return await ft(e)}else return await t.text()}function ft(t){return new Promise(e=>{let i=new FileReader;i.readAsDataURL(t),i.onloadend=function(){e(i.result)}})}var bt={codapi:G,browser:dt};a.engines={...a.engines,...bt};var l=c.HORIZONTAL_RULE,gt={javascript:`console.log("${l}");`,lua:`print("${l}")`,php:`echo "${l}"`,python:`print("${l}")`,r:`cat("${l}
")`,ruby:`puts "${l}"`,typescript:`console.log("${l}");`,shell:`echo "${l}"`,sql:`select '${l}';`};function wt(t){return gt[t]||""}var xt={hr:wt},Et={fallback:"✘ Failed, using fallback"},f={unknown:"unknown",running:"running",failed:"failed",succeded:"succeded"},k=document.createElement("template");k.innerHTML=`
<codapi-toolbar></codapi-toolbar>
<codapi-output hidden></codapi-output>
`;var C=class extends HTMLElement{constructor(){super(),this.ready=!1,this.executor=null,this._snippet=null,this._toolbar=null,this._output=null,this._fallback=null}connectedCallback(){if(this.ready)return;let t=parseInt(this.getAttribute("init-delay"),10)||0;yt(()=>{this.init(),this.render(),this.listen(),this.ready=!0,this.dispatchEvent(new Event("load"))},t)}init(){let t=this.getAttribute("files");this.executor=this.hasAttribute("sandbox")?new A({engine:this.getAttribute("engine"),sandbox:this.getAttribute("sandbox"),command:this.getAttribute("command"),template:this.getAttribute("template"),files:t?t.split(" "):null}):null,this.dependsOn=this.getAttribute("depends-on"),this.state=f.unknown}render(){this.appendChild(k.content.cloneNode(!0));let t=this.findCodeElement();this.snippet=new B(t,this.editor,this.execute.bind(this)),this._toolbar=this.querySelector("codapi-toolbar");let e=this.getAttribute("actions");this._toolbar.runnable=this.executor!=null,this._toolbar.addActions(e?e.split(" "):null);let i=this._toolbar.querySelector("codapi-status");this.hasAttribute("status-running")&&i.setAttribute("running",this.getAttribute("status-running")),this.hasAttribute("status-failed")&&i.setAttribute("failed",this.getAttribute("status-failed")),this.hasAttribute("status-done")&&i.setAttribute("done",this.getAttribute("status-done")),this._output=this.querySelector("codapi-output"),this._output.mode=this.getAttribute("output-mode"),this._output.tail=this.hasAttribute("output-tail"),this.hasAttribute("output")&&(this._fallback=this.extractFallback(this.getAttribute("output")))}listen(){this._toolbar.addEventListener("run",t=>{this.execute()}),this._toolbar.addEventListener("command",t=>{this.execute(t.detail)}),this._toolbar.addEventListener("event",t=>{this.dispatchEvent(new Event(t.detail))}),this.editor==b.basic&&(this._toolbar.editable=!0,this._toolbar.addEventListener("edit",t=>{this.snippet.focusEnd()})),this.snippet.addEventListener("hide",t=>{this._output.hide()})}findCodeElement(){if(!this.selector){let e=this.previousElementSibling||this.parentElement.previousElementSibling;return e.querySelector("code")||e}let t;if(this.selector.startsWith("@prev")){let e=this.previousElementSibling,[i,s]=c.cut(this.selector," ");t=e.querySelector(s)}else t=document.querySelector(this.selector);if(!t)throw Error(`element not found: ${this.selector}`);return t}extractFallback(t){let e=this.findOutputElement(t),i=(e.querySelector("code")||e).textContent.trim();return e.parentElement.removeChild(e),{ok:!1,duration:0,stdout:i,stderr:""}}findOutputElement(t){if(!t||t=="@next")return this.nextElementSibling||this.parentElement.nextElementSibling;let e;if(t.startsWith("@next")){let i=this.nextElementSibling,[s,n]=c.cut(t," ");e=i.querySelector(n)}else e=document.querySelector(t);if(!e)throw Error(`element not found: ${t}`);return e}async execute(t=void 0){if(this.executor){if(this.snippet.isEmpty){this._output.showMessage("(empty)");return}try{let e=vt(this);this.dispatchEvent(new CustomEvent("execute",{detail:e})),this.state=f.running,this._toolbar.showRunning(),this._output.fadeOut();let i=await this.executor.execute(t,e);this.state=i.ok?f.succeded:f.failed,this._toolbar.showFinished(i),this._output.showResult(i),this.dispatchEvent(new CustomEvent("result",{detail:i}))}catch(e){this._fallback?(this._toolbar.showStatus(Et.fallback),this._output.showResult(this._fallback)):(this._toolbar.showFinished({}),this._output.showMessage(e.message)),console.error(e),this.state=f.failed,this.dispatchEvent(new CustomEvent("error",{detail:e}))}finally{this._output.fadeIn()}}}attributeChangedCallback(t,e,i){switch(t){case"engine":case"sandbox":case"command":case"template":case"files":let s=this.getAttribute("files");this.executor=new A({engine:this.getAttribute("engine"),sandbox:this.getAttribute("sandbox"),command:this.getAttribute("command"),template:this.getAttribute("template"),files:s?s.split(" "):null});break}}showStatus(t){this._toolbar.showStatus(t)}get syntax(){return this.getAttribute("syntax")||this.getAttribute("sandbox")}set syntax(t){this.setAttribute("syntax",t)}get selector(){return this.getAttribute("selector")}set selector(t){this.setAttribute("selector",t)}get editor(){return this.getAttribute("editor")||b.off}set editor(t){this.setAttribute("editor",t)}get code(){return this.snippet.value}set code(t){this.snippet.value=t}get state(){return this.getAttribute("state")}set state(t){this.setAttribute("state",t)}};$(C,"observedAttributes",["sandbox","engine","command","template","files"]);function vt(t){let e=new Set,i=[],s=(r,o)=>{if(!r)throw new Error(`#${o} dependency not found`);e.has(o)||(e.add(o),r.dependsOn&&r.dependsOn.split(" ").forEach(d=>{s(document.getElementById(d),d)}),i.push(r.code))};s(t,t.id);let n=t.hasAttribute("output-tail")?xt.hr(t.syntax):"";return n?i.join(`
${n}
`):i.join(`
`)}function yt(t,e){if(e<=0){t();return}setTimeout(t,e)}window.customElements.get("codapi-snippet")||customElements.define("codapi-snippet",C)})();
